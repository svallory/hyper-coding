name: validated
description: |
  Generate a Server Action with Zod validation.
  Includes type-safe formData extraction, field-level errors, and schema validation.
version: 1.0.0

variables:
  name:
    type: string
    description: Action name in camelCase (e.g. "createUser", "updateProfile")
    required: true
    pattern: "^[a-z][a-zA-Z0-9]*$"

  fields:
    type: array
    description: |
      Form fields in format "name:type:validation" (e.g. "email:string:email", "age:number:min(18)")
      Supported types: string, number, boolean, date, enum
      Validations: email, url, min(n), max(n), length(n), optional, array
    required: true

  dir:
    type: string
    description: Output directory for Server Action
    default: "app/actions"

  schemaDir:
    type: string
    description: Output directory for Zod schema
    default: "lib/schemas"

  withPrevState:
    type: boolean
    description: Add prevState parameter for useActionState hook
    default: true

  returnPath:
    type: string
    description: Path to redirect/revalidate after success (optional)
    required: false

steps:
  - name: Check Zod dependency
    tool: shell
    command: |
      if ! bun pm ls zod &>/dev/null && ! npm list zod &>/dev/null; then
        echo "Installing zod..."
        if command -v bun &> /dev/null; then
          bun add zod
        elif command -v pnpm &> /dev/null; then
          pnpm add zod
        elif command -v yarn &> /dev/null; then
          yarn add zod
        else
          npm install zod
        fi
      fi

  - name: Create directories
    tool: shell
    command: |
      mkdir -p {{ dir }}
      mkdir -p {{ schemaDir }}

  - name: Generate Zod schema
    tool: template
    template: templates/schema.ts.jig

  - name: Generate Server Action
    tool: template
    template: templates/action.ts.jig

  - name: Instructions
    tool: shell
    command: |
      echo "âœ… Validated Server Action generated successfully!"
      echo ""
      echo "Created files:"
      echo "  - {{ dir }}/{{ name }}.ts"
      echo "  - {{ schemaDir }}/{{ kebabCase(name) }}.ts"
      echo ""
      echo "Usage with useActionState:"
      echo "  'use client'"
      echo "  import { useActionState } from 'react'"
      echo "  import { {{ name }} } from '@/{{ dir }}/{{ name }}'"
      echo ""
      echo "  export function MyForm() {"
      echo "    const [state, formAction, pending] = useActionState({{ name }}, null)"
      echo ""
      echo "    return ("
      echo "      <form action={formAction}>"
      echo "        {/* Field-level error display */}"
      echo "        {state?.errors?.fieldName && ("
      echo "          <p className=\"text-red-500\">{state.errors.fieldName[0]}</p>"
      echo "        )}"
      echo "        <button disabled={pending}>Submit</button>"
      echo "      </form>"
      echo "    )"
      echo "  }"
      echo ""
      echo "The schema is also exported and can be reused:"
      echo "  import { {{ camelCase(name) }}Schema } from '@/{{ schemaDir }}/{{ kebabCase(name) }}'"
