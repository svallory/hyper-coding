name: drizzle
description: |
  Initialize Drizzle ORM in a Next.js project.
  Sets up Drizzle schema, client, and database connection.
version: 1.0.0

variables:
  database:
    type: enum
    description: Database provider
    values: [postgresql, mysql, sqlite]
    default: postgresql

  databaseUrl:
    type: string
    description: Database connection URL (optional, can be set in .env later)
    required: false

steps:
  - name: Install Drizzle ORM
    tool: install
    packages: [drizzle-orm]

  - name: Install PostgreSQL driver
    tool: install
    packages: [postgres]
    when: "database === 'postgresql'"

  - name: Install MySQL driver
    tool: install
    packages: [mysql2]
    when: "database === 'mysql'"

  - name: Install SQLite driver
    tool: install
    packages: ["better-sqlite3"]
    when: "database === 'sqlite'"

  - name: Install Drizzle Kit
    tool: install
    packages: [drizzle-kit]
    dev: true

  - name: Install PostgreSQL types
    tool: install
    packages: ["@types/pg"]
    dev: true
    when: "database === 'postgresql'"

  - name: Install SQLite types
    tool: install
    packages: ["@types/better-sqlite3"]
    dev: true
    when: "database === 'sqlite'"

  - name: Create Drizzle config
    tool: template
    template: templates/drizzle.config.ts.jig

  - name: Create database client
    tool: template
    template: templates/db-client.ts.jig

  - name: Create example schema
    tool: template
    template: templates/example-schema.ts.jig

  - name: Update .env with database URL
    tool: shell
    command: |
      if [ ! -f .env ]; then
        echo "Creating .env file..."
        touch .env
      fi
      if ! grep -q "DATABASE_URL" .env; then
        echo "" >> .env
        echo "# Database" >> .env
        @if(databaseUrl)
          echo "DATABASE_URL=\"{{ databaseUrl }}\"" >> .env
        @else if(database === 'postgresql')
          echo "DATABASE_URL=\"postgresql://user:password@localhost:5432/mydb\"" >> .env
        @else if(database === 'mysql')
          echo "DATABASE_URL=\"mysql://user:password@localhost:3306/mydb\"" >> .env
        @else if(database === 'sqlite')
          echo "DATABASE_URL=\"file:./local.db\"" >> .env
        @end
      fi

  - name: Update package.json scripts
    tool: shell
    command: |
      if command -v bun &> /dev/null; then
        npm pkg set scripts.db:generate="drizzle-kit generate"
        npm pkg set scripts.db:migrate="drizzle-kit migrate"
        npm pkg set scripts.db:push="drizzle-kit push"
        npm pkg set scripts.db:studio="drizzle-kit studio"
      fi

onSuccess: |
  Drizzle ORM initialized successfully!

  Next steps:
    1. Update DATABASE_URL in .env with your database credentials
    2. Edit db/schema/*.ts to define your data models
    3. Run 'bun run db:generate' to generate migrations
    4. Run 'bun run db:migrate' to apply migrations
    5. Import db: import { db } from '@/db'

  Available commands:
    bun run db:generate  - Generate migrations from schema
    bun run db:migrate   - Apply migrations to database
    bun run db:push      - Push schema changes directly (dev only)
    bun run db:studio    - Launch Drizzle Studio GUI
