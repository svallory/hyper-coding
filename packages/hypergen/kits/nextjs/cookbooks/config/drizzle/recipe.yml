name: drizzle
description: |
  Initialize Drizzle ORM in a Next.js project.
  Sets up Drizzle schema, client, and database connection.
version: 1.0.0

variables:
  database:
    type: enum
    description: Database provider
    values: [postgresql, mysql, sqlite]
    default: postgresql

  databaseUrl:
    type: string
    description: Database connection URL (optional, can be set in .env later)
    required: false

steps:
  - name: Install Drizzle dependencies
    tool: shell
    command: |
      if command -v bun &> /dev/null; then
        bun add drizzle-orm @if(database === 'postgresql')
postgres@else if(database === 'mysql')
mysql2@else if(database === 'sqlite')
better-sqlite3@end

        bun add -d drizzle-kit @if(database === 'postgresql')
@types/pg@else if(database === 'mysql')
@types/mysql2@else if(database === 'sqlite')
@types/better-sqlite3@end

      elif command -v pnpm &> /dev/null; then
        pnpm add drizzle-orm @if(database === 'postgresql')
postgres@else if(database === 'mysql')
mysql2@else if(database === 'sqlite')
better-sqlite3@end

        pnpm add -D drizzle-kit @if(database === 'postgresql')
@types/pg@else if(database === 'mysql')
@types/mysql2@else if(database === 'sqlite')
@types/better-sqlite3@end

      elif command -v yarn &> /dev/null; then
        yarn add drizzle-orm @if(database === 'postgresql')
postgres@else if(database === 'mysql')
mysql2@else if(database === 'sqlite')
better-sqlite3@end

        yarn add -D drizzle-kit @if(database === 'postgresql')
@types/pg@else if(database === 'mysql')
@types/mysql2@else if(database === 'sqlite')
@types/better-sqlite3@end

      else
        npm install drizzle-orm @if(database === 'postgresql')
postgres@else if(database === 'mysql')
mysql2@else if(database === 'sqlite')
better-sqlite3@end

        npm install -D drizzle-kit @if(database === 'postgresql')
@types/pg@else if(database === 'mysql')
@types/mysql2@else if(database === 'sqlite')
@types/better-sqlite3@end

      fi

  - name: Create Drizzle config
    tool: template
    template: templates/drizzle.config.ts.jig

  - name: Create database client
    tool: template
    template: templates/db-client.ts.jig

  - name: Create schema directory
    tool: shell
    command: mkdir -p db/schema

  - name: Create example schema
    tool: template
    template: templates/example-schema.ts.jig

  - name: Update .env with database URL
    tool: shell
    command: |
      if [ ! -f .env ]; then
        echo "Creating .env file..."
        touch .env
      fi
      if ! grep -q "DATABASE_URL" .env; then
        echo "" >> .env
        echo "# Database" >> .env
        @if(databaseUrl)
          echo "DATABASE_URL=\"{{ databaseUrl }}\"" >> .env
        @else if(database === 'postgresql')
          echo "DATABASE_URL=\"postgresql://user:password@localhost:5432/mydb\"" >> .env
        @else if(database === 'mysql')
          echo "DATABASE_URL=\"mysql://user:password@localhost:3306/mydb\"" >> .env
        @else if(database === 'sqlite')
          echo "DATABASE_URL=\"file:./local.db\"" >> .env
        @end
      fi

  - name: Update package.json scripts
    tool: shell
    command: |
      if command -v bun &> /dev/null; then
        npm pkg set scripts.db:generate="drizzle-kit generate"
        npm pkg set scripts.db:migrate="drizzle-kit migrate"
        npm pkg set scripts.db:push="drizzle-kit push"
        npm pkg set scripts.db:studio="drizzle-kit studio"
      fi

  - name: Instructions
    tool: shell
    command: |
      echo "âœ… Drizzle ORM initialized successfully!"
      echo ""
      echo "Next steps:"
      echo "  1. Update DATABASE_URL in .env with your database credentials"
      echo "  2. Edit db/schema/*.ts to define your data models"
      echo "  3. Run 'bun run db:generate' to generate migrations"
      echo "  4. Run 'bun run db:migrate' to apply migrations"
      echo "  5. Import db: import { db } from '@/db'"
      echo ""
      echo "Available commands:"
      echo "  bun run db:generate  - Generate migrations from schema"
      echo "  bun run db:migrate   - Apply migrations to database"
      echo "  bun run db:push      - Push schema changes directly (dev only)"
      echo "  bun run db:studio    - Launch Drizzle Studio GUI"
